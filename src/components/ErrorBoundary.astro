---
/**
 * é”™è¯¯è¾¹ç•Œç»„ä»¶
 * æ•è·å­ç»„ä»¶ä¸­çš„é”™è¯¯ï¼Œæ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
 * 
 * @example
 * ```astro
 * <ErrorBoundary fallback="åŠ è½½å¤±è´¥" showErrorDetails={true}>
 *     <MyComponent />
 * </ErrorBoundary>
 * ```
 */

interface Props {
    /** é”™è¯¯æ—¶æ˜¾ç¤ºçš„æç¤ºä¿¡æ¯ */
    fallback?: string;
    /** æ˜¯å¦æ˜¾ç¤ºé”™è¯¯è¯¦æƒ…ï¼ˆä»…å¼€å‘ç¯å¢ƒå»ºè®®å¼€å¯ï¼‰ */
    showErrorDetails?: boolean;
    /** æ˜¯å¦å…è®¸å°è¯•æ¢å¤ */
    allowRecover?: boolean;
}

const { 
    fallback = "ç»„ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚", 
    showErrorDetails = false,
    allowRecover = true 
} = Astro.props;
---

<slot />

<div id="error-boundary" class="error-boundary" style="display: none;" data-allow-recover={allowRecover}>
    <div class="error-container">
        <div class="error-badge" id="error-badge">å¯æ¢å¤</div>
        <div class="error-icon" id="error-icon">âš ï¸</div>
        <h2 class="error-title" id="error-title">å‡ºé”™äº†</h2>
        <p class="error-message">{fallback}</p>
        {showErrorDetails && (
            <div class="error-details">
                <h3>é”™è¯¯è¯¦æƒ…</h3>
                <pre id="error-stack" class="error-stack"></pre>
            </div>
        )}
        <div class="error-actions">
            {allowRecover && (
                <button class="error-recover" id="error-recover-btn">
                    ğŸ”„ å°è¯•æ¢å¤
                </button>
            )}
            <button class="error-retry" onclick="window.location.reload()">
                åˆ·æ–°é¡µé¢
            </button>
            <button class="error-report" id="error-report-btn">
                ğŸ“ æŠ¥å‘Šé—®é¢˜
            </button>
        </div>
    </div>
</div>

<script>
    import { setupGlobalErrorHandlers, registerErrorHandler, ErrorType, type ErrorInfo } from "../utils/error-handler";

    // é”™è¯¯åˆ†ç±»
    type ErrorSeverity = 'recoverable' | 'fatal';
    
    function classifyError(error: ErrorInfo): ErrorSeverity {
        // ç½‘ç»œé”™è¯¯å’Œå›¾ç‰‡é”™è¯¯é€šå¸¸å¯æ¢å¤
        if (error.type === ErrorType.NETWORK_ERROR || error.type === ErrorType.IMAGE_ERROR) {
            return 'recoverable';
        }
        // è„šæœ¬é”™è¯¯æ ¹æ®æ¶ˆæ¯åˆ¤æ–­
        if (error.message?.includes('ChunkLoadError') || 
            error.message?.includes('Loading chunk')) {
            return 'recoverable';
        }
        return 'fatal';
    }

    // ä¸ŠæŠ¥é”™è¯¯åˆ° Umami
    function reportErrorToUmami(error: ErrorInfo, severity: ErrorSeverity) {
        const umami = (window as unknown as { umami?: { track: (e: string, d: Record<string, unknown>) => void } }).umami;
        if (umami?.track) {
            umami.track('error-boundary', {
                type: error.type,
                severity,
                message: error.message?.slice(0, 100),
                url: error.url,
            });
        }
    }

    // è®¾ç½®å…¨å±€é”™è¯¯å¤„ç†å™¨
    setupGlobalErrorHandlers();

    // ä½¿ç”¨ Symbol é˜²æ­¢é‡å¤æ¸…ç†
    const cleanupSymbol = Symbol.for('errorBoundaryCleanup');
    const controller = new AbortController();
    let currentError: ErrorInfo | null = null;

    // æ³¨å†Œé”™è¯¯å¤„ç†å™¨
    const unregister = registerErrorHandler(ErrorType.COMPONENT_ERROR, (error: ErrorInfo) => {
        const errorBoundary = document.getElementById("error-boundary");
        if (!errorBoundary) return;

        currentError = error;
        const severity = classifyError(error);
        
        // æ›´æ–° UI åŸºäºé”™è¯¯ä¸¥é‡ç¨‹åº¦
        const badge = document.getElementById("error-badge");
        const icon = document.getElementById("error-icon");
        const title = document.getElementById("error-title");
        const recoverBtn = document.getElementById("error-recover-btn");
        
        if (severity === 'fatal') {
            if (badge) { badge.textContent = 'ä¸¥é‡é”™è¯¯'; badge.classList.add('fatal'); }
            if (icon) icon.textContent = 'ğŸ’¥';
            if (title) title.textContent = 'å‘ç”Ÿä¸¥é‡é”™è¯¯';
            if (recoverBtn) recoverBtn.style.display = 'none';
        } else {
            if (badge) { badge.textContent = 'å¯æ¢å¤'; badge.classList.remove('fatal'); }
            if (icon) icon.textContent = 'âš ï¸';
            if (title) title.textContent = 'å‡ºé”™äº†';
            if (recoverBtn) recoverBtn.style.display = 'inline-flex';
        }

        const errorStack = document.getElementById("error-stack");
        if (errorStack && error.stack) {
            errorStack.textContent = error.stack;
        }

        reportErrorToUmami(error, severity);
        errorBoundary.style.display = "flex";
    });

    // æ¢å¤æŒ‰é’®å¤„ç†
    document.getElementById("error-recover-btn")?.addEventListener("click", () => {
        const errorBoundary = document.getElementById("error-boundary");
        if (errorBoundary) {
            errorBoundary.style.display = "none";
            currentError = null;
        }
    });

    // æŠ¥å‘Šé—®é¢˜æŒ‰é’®
    document.getElementById("error-report-btn")?.addEventListener("click", () => {
        const subject = encodeURIComponent('ç½‘ç«™é”™è¯¯æŠ¥å‘Š');
        const body = encodeURIComponent(
            `é”™è¯¯ä¿¡æ¯:\n${currentError?.message || 'æœªçŸ¥é”™è¯¯'}\n\n` +
            `é¡µé¢: ${window.location.href}\n` +
            `æ—¶é—´: ${new Date().toISOString()}\n` +
            `æµè§ˆå™¨: ${navigator.userAgent}`
        );
        window.open(`mailto:support@huat-fsac.eu.org?subject=${subject}&body=${body}`, '_blank');
    });

    // ç»Ÿä¸€æ¸…ç†å‡½æ•°
    function cleanup() {
        const win = window as unknown as { [key: symbol]: boolean };
        if (win[cleanupSymbol]) return;
        win[cleanupSymbol] = true;
        unregister();
        controller.abort();
    }

    document.addEventListener("astro:page-load", cleanup, { signal: controller.signal });
    window.addEventListener("beforeunload", cleanup, { signal: controller.signal });
</script>

<style>
    .error-boundary {
        position: fixed;
        inset: 0;
        z-index: 99999;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    }

    .error-container {
        background: var(--sl-color-bg);
        border-radius: 1rem;
        padding: 2.5rem;
        max-width: 500px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        border: 1px solid var(--sl-color-gray-5);
        position: relative;
    }

    .error-badge {
        position: absolute;
        top: -0.75rem;
        left: 50%;
        transform: translateX(-50%);
        background: #27ae60;
        color: #fff;
        padding: 0.25rem 1rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
    }

    .error-badge.fatal {
        background: #e74c3c;
    }

    .error-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    .error-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--sl-color-text);
        margin: 0 0 1rem 0;
    }

    .error-message {
        font-size: 1rem;
        color: var(--sl-color-text-gray);
        line-height: 1.6;
        margin: 0 0 1.5rem 0;
    }

    .error-details {
        background: var(--sl-color-gray-6);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
        text-align: left;
    }

    .error-details h3 {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--sl-color-text);
        margin: 0 0 0.75rem 0;
    }

    .error-stack {
        font-size: 0.75rem;
        color: var(--sl-color-gray-2);
        background: var(--sl-color-gray-7);
        padding: 0.75rem;
        border-radius: 0.375rem;
        overflow-x: auto;
        white-space: pre-wrap;
        word-break: break-all;
        margin: 0;
    }

    .error-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        justify-content: center;
    }

    .error-retry,
    .error-recover,
    .error-report {
        border: none;
        padding: 0.75rem 1.5rem;
        font-size: 0.95rem;
        font-weight: 600;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .error-retry {
        background: var(--sl-color-accent);
        color: #000;
    }

    .error-recover {
        background: #27ae60;
        color: #fff;
    }

    .error-report {
        background: var(--sl-color-gray-5);
        color: var(--sl-color-text);
    }

    .error-retry:hover,
    .error-recover:hover,
    .error-report:hover {
        transform: translateY(-2px);
    }

    .error-retry:hover {
        box-shadow: 0 4px 12px rgba(243, 156, 18, 0.4);
    }

    .error-recover:hover {
        box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
    }

    @media (max-width: 640px) {
        .error-container {
            padding: 2rem;
            margin: 1rem;
        }

        .error-icon {
            font-size: 3rem;
        }

        .error-title {
            font-size: 1.5rem;
        }

        .error-actions {
            flex-direction: column;
        }

        .error-retry,
        .error-recover,
        .error-report {
            width: 100%;
            justify-content: center;
        }
    }
</style>
