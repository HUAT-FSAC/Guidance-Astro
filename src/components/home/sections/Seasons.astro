---
import type { SeasonItem } from "../../../data/home";
import { optimizeExternalImage } from "../../../utils/image-optimization";
import ChevronLeft from "../../icons/ChevronLeft.astro";
import ChevronRight from "../../icons/ChevronRight.astro";

interface Props {
    seasons: SeasonItem[];
}

const { seasons } = Astro.props;
---

<div class="seasons-carousel-container" role="region" aria-roledescription="carousel" aria-label="ËµõÂ≠£ÂõûÈ°æ">
    <div class="carousel-viewport" id="seasonsViewport">
        <div class="carousel-track" id="seasonsTrack" aria-live="polite">
            {
                seasons.map((season, index) => {
                    const teamImg = optimizeExternalImage(season.teamImg, 900);
                    const carImg = optimizeExternalImage(season.carImg, 900);
                    return (
                        <div class="carousel-slide" data-index={index}>
                        <div class="season-card">
                            <div class="season-header">
                                <div class="season-year">{season.year}</div>
                                <div class="season-badge">Season Team</div>
                            </div>

                            <div class="season-content">
                                {/* ÂõæÁâáÂ±ïÁ§∫Âå∫ */}
                                <div class="season-gallery">
                                    <div class="gallery-item">
                                        <img
                                            src={teamImg}
                                            alt={`${season.year} ËµõÂ≠£Âõ¢ÈòüÂêàÂΩ±`}
                                            loading="lazy"
                                            decoding="async"
                                        />
                                        <div class="gallery-caption">
                                            The Team
                                        </div>
                                    </div>
                                    <div class="gallery-item">
                                        <img
                                            src={carImg}
                                            alt={`${season.year} ËµõÂ≠£ËµõËΩ¶`}
                                            loading="lazy"
                                            decoding="async"
                                        />
                                        <div class="gallery-caption">
                                            The Machine
                                        </div>
                                    </div>
                                </div>

                                {/* Âõ¢Èòü‰ø°ÊÅØÂå∫ */}
                                <div class="team-info">
                                    {/* ÊåáÂØºËÄÅÂ∏àÂíåÈòüÈïø */}
                                    <div class="leadership">
                                        {season.advisor && (
                                            <div class="leader-card">
                                                <div class="leader-icon">
                                                    üë®‚Äçüè´
                                                </div>
                                                <div class="leader-details">
                                                    <span class="leader-role">
                                                        ÊåáÂØºËÄÅÂ∏à
                                                    </span>
                                                    <span class="leader-name">
                                                        {season.advisor}
                                                    </span>
                                                </div>
                                            </div>
                                        )}
                                        {season.captain && (
                                            <div class="leader-card">
                                                <div class="leader-icon">
                                                    üéñÔ∏è
                                                </div>
                                                <div class="leader-details">
                                                    <span class="leader-role">
                                                        ÈòüÈïø
                                                    </span>
                                                    <span class="leader-name">
                                                        {season.captain}
                                                    </span>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* ÊàêÂëòÂàóË°® */}
                                    {season.members &&
                                        season.members.length > 0 && (
                                            <div class="members-section">
                                                <div class="members-grid">
                                                    {season.members.map(
                                                        (group: { group: string; names: string[] }) => (
                                                            <div class="member-group">
                                                                <div class="group-name">
                                                                    {
                                                                        group.group
                                                                    }
                                                                </div>
                                                                <div class="group-members">
                                                                    {group.names.map(
                                                                        (
                                                                            name: string,
                                                                        ) => (
                                                                            <span class="member-name">
                                                                                {
                                                                                    name
                                                                                }
                                                                            </span>
                                                                        ),
                                                                    )}
                                                                </div>
                                                            </div>
                                                        ),
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                </div>
                            </div>
                        </div>
                    </div>
                    );
                })
            }
        </div>
    </div>

    {/* ÂØºËà™ÊåâÈíÆ */}
    <button class="carousel-nav prev" id="prevBtn" aria-label="Previous Season">
        <ChevronLeft size={24} />
    </button>
    <button class="carousel-nav next" id="nextBtn" aria-label="Next Season">
        <ChevronRight size={24} />
    </button>

    {/* ÊåáÁ§∫Âô® */}
    <div class="carousel-indicators">
        {
            seasons.map((_, index) => (
                <button
                    class={`indicator ${index === 0 ? "active" : ""}`}
                    data-index={index}
                    aria-label={`Go to slide ${index + 1}`}
                />
            ))
        }
    </div>
</div>

<script>
    function initCarousel() {
        const viewport = document.getElementById("seasonsViewport");
        const track = document.getElementById("seasonsTrack");
        const slides = document.querySelectorAll(".carousel-slide");
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");
        const indicators = document.querySelectorAll(".indicator");

        const prefersReducedMotion = window.matchMedia(
            "(prefers-reduced-motion: reduce)",
        ).matches;
        const isSmallScreen = window.matchMedia("(max-width: 768px)").matches;

        if (!track || slides.length === 0) return;
        if ((track as HTMLElement).dataset.initialized === "true") return;
        if (isSmallScreen) {
            (track as HTMLElement).dataset.initialized = "true";
            return;
        }

        (track as HTMLElement).dataset.initialized = "true";

        const enableAutoPlay = !prefersReducedMotion;

        let currentIndex = 0;
        const totalSlides = slides.length;

        function updateCarousel() {
            // ÁßªÂä®ËΩ®ÈÅì
            track!.style.transform = `translateX(-${currentIndex * 100}%)`;

            // Êõ¥Êñ∞ÊåáÁ§∫Âô®
            indicators.forEach((ind, i) => {
                if (i === currentIndex) ind.classList.add("active");
                else ind.classList.remove("active");
            });
        }

        function nextSlide() {
            currentIndex = (currentIndex + 1) % totalSlides;
            updateCarousel();
        }

        function prevSlide() {
            currentIndex = (currentIndex - 1 + totalSlides) % totalSlides;
            updateCarousel();
        }

        // ‰∫ã‰ª∂ÁõëÂê¨
        nextBtn?.addEventListener("click", () => {
            nextSlide();
            resetAutoPlay();
        });

        prevBtn?.addEventListener("click", () => {
            prevSlide();
            resetAutoPlay();
        });

        indicators.forEach((ind) => {
            ind.addEventListener("click", (e) => {
                const target = e.target as HTMLElement;
                const index = parseInt(target.dataset.index || "0");
                currentIndex = index;
                updateCarousel();
                resetAutoPlay();
            });
        });

        // Ëá™Âä®Êí≠Êîæ
        let autoPlayInterval: ReturnType<typeof setInterval> | null = null;

        function startAutoPlay() {
            if (!enableAutoPlay || autoPlayInterval) return;
            autoPlayInterval = setInterval(nextSlide, 5000); // 5ÁßíÂàáÊç¢‰∏ÄÊ¨°
        }

        function stopAutoPlay() {
            if (!autoPlayInterval) return;
            clearInterval(autoPlayInterval);
            autoPlayInterval = null;
        }

        function resetAutoPlay() {
            if (!enableAutoPlay) return;
            stopAutoPlay();
            startAutoPlay();
        }

        // Ëß¶Êë∏ÊªëÂä®ÊîØÊåÅ
        let touchStartX = 0;
        let touchEndX = 0;

        track.addEventListener(
            "touchstart",
            (e) => {
                touchStartX = e.changedTouches[0].screenX;
                if (enableAutoPlay) stopAutoPlay();
            },
            { passive: true },
        );

        track.addEventListener(
            "touchend",
            (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
                if (enableAutoPlay) startAutoPlay();
            },
            { passive: true },
        );

        function handleSwipe() {
            if (touchEndX < touchStartX - 50) nextSlide();
            if (touchEndX > touchStartX + 50) prevSlide();
        }

        // ÂêØÂä®Ôºö‰ªÖÂú®ÂèØËßÅÊó∂Ëá™Âä®Êí≠Êîæ
        if (enableAutoPlay) {
            if (viewport) {
                const observer = new IntersectionObserver(
                    (entries) => {
                        entries.forEach((entry) => {
                            if (entry.isIntersecting) startAutoPlay();
                            else stopAutoPlay();
                        });
                    },
                    { threshold: 0.2 },
                );
                observer.observe(viewport);
            } else {
                startAutoPlay();
            }

            track.addEventListener("mouseenter", stopAutoPlay);
            track.addEventListener("mouseleave", startAutoPlay);
        }
    }

    // ÂàùÂßãÂåñ
    function scheduleInit() {
        const viewport = document.getElementById("seasonsViewport");
        if (!viewport) return;

        if ("IntersectionObserver" in window) {
            const observer = new IntersectionObserver(
                (entries) => {
                    entries.forEach((entry) => {
                        if (entry.isIntersecting) {
                            observer.disconnect();
                            initCarousel();
                        }
                    });
                },
                { rootMargin: "200px" },
            );
            observer.observe(viewport);
        } else {
            initCarousel();
        }
    }

    if (
        document.readyState === "complete" ||
        document.readyState === "interactive"
    ) {
        scheduleInit();
    } else {
        document.addEventListener("DOMContentLoaded", scheduleInit, {
            once: true,
        });
    }

    document.addEventListener("astro:page-load", scheduleInit);
</script>

<style>
    .seasons-carousel-container {
        position: relative;
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        overflow: hidden;
        padding: 2rem 0;
    }

    .carousel-viewport {
        overflow: hidden;
        border-radius: 1rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    :global([data-theme="light"]) .carousel-viewport {
        background: #fff;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .carousel-track {
        display: flex;
        transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);
        width: 100%;
    }

    .carousel-slide {
        min-width: 100%;
        box-sizing: border-box;
        padding: 2rem;
    }

    .season-card {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .season-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 1rem;
    }

    :global([data-theme="light"]) .season-header {
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .season-year {
        font-size: 2.5rem;
        font-weight: 900;
        color: var(--sl-color-accent);
        line-height: 1;
    }

    .season-badge {
        background: var(--sl-color-accent);
        color: #fff;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
    }

    :global([data-theme="light"]) .season-badge {
        color: #000;
    }

    .season-content {
        display: flex;
        flex-direction: column;
        gap: 2.5rem;
    }

    /* ÂõæÁâáÂå∫Âüü */
    .season-gallery {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }

    @media (max-width: 768px) {
        .season-gallery {
            grid-template-columns: 1fr;
        }
    }

    .gallery-item {
        position: relative;
        border-radius: 0.75rem;
        overflow: hidden;
        aspect-ratio: 16/9;
    }

    .gallery-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
    }

    .gallery-item:hover img {
        transform: scale(1.05);
    }

    .gallery-caption {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
        color: #fff;
        padding: 1rem;
        font-size: 0.9rem;
        font-weight: 600;
    }

    /* Âõ¢Èòü‰ø°ÊÅØÂå∫Âüü */
    .team-info {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .leadership {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
    }

    .leader-card {
        display: flex;
        align-items: center;
        gap: 1rem;
        background: rgba(255, 255, 255, 0.05);
        padding: 0.75rem 1.25rem;
        border-radius: 0.75rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    :global([data-theme="light"]) .leader-card {
        background: rgba(0, 0, 0, 0.03);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .leader-icon {
        font-size: 1.5rem;
    }

    .leader-details {
        display: flex;
        flex-direction: column;
    }

    .leader-role {
        font-size: 0.75rem;
        text-transform: uppercase;
        opacity: 0.7;
        font-weight: 600;
    }

    .leader-name {
        font-weight: 700;
        font-size: 1rem;
        color: var(--sl-color-text);
    }

    /* ÊàêÂëòÂàóË°® */
    .members-section {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 1rem;
        padding: 1.5rem;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    :global([data-theme="light"]) .members-section {
        background: rgba(0, 0, 0, 0.02);
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .members-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1.5rem;
    }

    .member-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .group-name {
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--sl-color-accent);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 0.25rem;
        margin-bottom: 0.25rem;
    }

    :global([data-theme="light"]) .group-name {
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .group-members {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .member-name {
        font-size: 0.85rem;
        opacity: 0.8;
        background: rgba(255, 255, 255, 0.05);
        padding: 0.1rem 0.4rem;
        border-radius: 4px;
    }

    :global([data-theme="light"]) .member-name {
        background: rgba(0, 0, 0, 0.05);
    }

    /* ÂØºËà™ÊåâÈíÆ */
    .carousel-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.5);
        color: #fff;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 10;
    }

    .carousel-nav:hover {
        background: var(--sl-color-accent);
        transform: translateY(-50%) scale(1.1);
    }

    .carousel-nav.prev {
        left: 10px;
    }
    .carousel-nav.next {
        right: 10px;
    }

    /* ÊåáÁ§∫Âô® */
    .carousel-indicators {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.8rem;
        margin-top: 1.5rem;
        height: 20px;
    }

    .indicator {
        width: 10px;
        height: 10px;
        padding: 0;
        margin: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        appearance: none;
        display: block;
    }

    :global([data-theme="light"]) .indicator {
        background: rgba(0, 0, 0, 0.2);
    }

    .indicator.active {
        background: var(--sl-color-accent);
        transform: scale(1.2);
    }

    @media (max-width: 640px) {
        .carousel-slide {
            padding: 1rem;
        }

        .season-year {
            font-size: 2rem;
        }

        .members-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .carousel-viewport {
            box-shadow: none;
            background: transparent;
            border: none;
        }

        .carousel-track {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            transform: none !important;
        }

        .carousel-slide {
            padding: 0;
        }

        .season-card {
            gap: 1.5rem;
        }

        .carousel-nav,
        .carousel-indicators {
            display: none;
        }
    }
</style>
