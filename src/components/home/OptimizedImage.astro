---
/**
 * 优化图片组件
 * 支持 WebP 格式、懒加载、模糊占位符
 */

interface Props {
    src: string;
    alt: string;
    width?: number;
    height?: number;
    class?: string;
    loading?: "lazy" | "eager";
    aspectRatio?: string;
}

const {
    src,
    alt,
    width,
    height,
    class: className = "",
    loading = "lazy",
    aspectRatio = "16/9",
} = Astro.props;

// 判断是否为外部 URL
const isExternal = src.startsWith("http://") || src.startsWith("https://");

// 如果是 Unsplash 图片，自动转换为 WebP 并添加尺寸参数
function optimizeUrl(url: string): { webp: string; fallback: string } {
    if (url.includes("unsplash.com")) {
        const base = url.split("?")[0];
        return {
            webp: `${base}?fm=webp&w=${width || 800}&q=80`,
            fallback: `${base}?fm=jpg&w=${width || 800}&q=80`,
        };
    }
    return { webp: url, fallback: url };
}

const optimized = isExternal ? optimizeUrl(src) : { webp: src, fallback: src };
---

<div
    class={`optimized-image-wrapper ${className}`}
    style={`aspect-ratio: ${aspectRatio}`}
>
    <div class="image-placeholder"></div>
    <picture>
        {
            isExternal && src.includes("unsplash.com") && (
                <source srcset={optimized.webp} type="image/webp" />
            )
        }
        <img
            src={optimized.fallback}
            alt={alt}
            width={width}
            height={height}
            loading={loading}
            decoding="async"
            class="optimized-image"
            onload="this.parentElement.parentElement.classList.add('loaded')"
        />
    </picture>
</div>

<style>
    .optimized-image-wrapper {
        position: relative;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.05);
    }

    .image-placeholder {
        position: absolute;
        inset: 0;
        background: linear-gradient(
            90deg,
            rgba(255, 255, 255, 0.03) 0%,
            rgba(255, 255, 255, 0.08) 50%,
            rgba(255, 255, 255, 0.03) 100%
        );
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
        0% {
            background-position: 200% 0;
        }
        100% {
            background-position: -200% 0;
        }
    }

    .optimized-image-wrapper.loaded .image-placeholder {
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .optimized-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0;
        transition:
            opacity 0.5s ease,
            transform 0.5s ease;
    }

    .optimized-image-wrapper.loaded .optimized-image {
        opacity: 1;
    }

    .optimized-image-wrapper:hover .optimized-image {
        transform: scale(1.05);
    }
</style>
