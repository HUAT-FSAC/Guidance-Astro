---
// 页面加载动画组件
---

<div class="page-loader" id="pageLoader">
    <div class="loader-content">
        <div class="loader-logo">
            <span class="logo-text">HUAT</span>
            <span class="logo-accent">FSAC</span>
        </div>
        <div class="loader-bar">
            <div class="loader-progress"></div>
        </div>
    </div>
</div>

<script is:inline>
    // 使用立即执行函数 (IIFE) 避免污染全局作用域
    // 使用 is:inline 确保脚本在 HTML 解析时立即执行，防止页面闪烁
    (function () {
        var loader = document.getElementById("pageLoader");
        if (!loader) return;

        var STORAGE_KEY = "huat_fsac_visited";
        var hasVisited = sessionStorage.getItem(STORAGE_KEY);

        if (hasVisited) {
            // 立即隐藏，防止闪烁
            loader.style.display = "none";
            loader.classList.add("loaded");

            // 触发事件，通知依赖此事件的组件 (如 Stats)
            // 使用 requestAnimationFrame 确保在下一帧触发，给其他脚本一点加载时间
            requestAnimationFrame(function () {
                window.dispatchEvent(new CustomEvent("pageLoaderHidden"));
            });
            return;
        }

        // 场景 B: 首次访问
        // 标记本次会话已访问
        sessionStorage.setItem(STORAGE_KEY, "true");

        var MIN_VISIBLE_MS = 350;
        var MAX_WAIT_MS = 1500;
        var startTime = Date.now();

        function revealContent() {
            if (loader.classList.contains("loaded")) return;
            loader.classList.add("loaded");

            // 等待 CSS transition 完成后彻底隐藏
            setTimeout(function () {
                loader.style.display = "none";
                window.dispatchEvent(new CustomEvent("pageLoaderHidden"));
            }, 250);
        }

        function hideLoader() {
            if (loader.classList.contains("loaded")) return;
            var elapsed = Date.now() - startTime;
            var delay = Math.max(0, MIN_VISIBLE_MS - elapsed);
            setTimeout(revealContent, delay);
        }

        // 首次访问时，等待 DOM 就绪即可隐藏，避免阻塞图片加载
        if (
            document.readyState === "complete" ||
            document.readyState === "interactive"
        ) {
            hideLoader();
        } else {
            document.addEventListener("DOMContentLoaded", hideLoader, {
                once: true,
            });
        }

        // 保底策略：如果长时间没有完成，强制进入
        setTimeout(hideLoader, MAX_WAIT_MS);
    })();
</script>

<style>
    .page-loader {
        position: fixed;
        inset: 0;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        transition:
            opacity 0.2s ease,
            visibility 0.2s ease;
    }

    :global([data-theme="light"]) .page-loader {
        background: #fff;
    }

    .page-loader.loaded {
        opacity: 0;
        visibility: hidden;
    }

    .loader-content {
        text-align: center;
    }

    .loader-logo {
        font-size: 3rem;
        font-weight: 900;
        letter-spacing: -2px;
        margin-bottom: 2rem;
    }

    .logo-text {
        color: #fff;
    }

    :global([data-theme="light"]) .logo-text {
        color: #000;
    }

    .logo-accent {
        color: var(--sl-color-accent, #f39c12);
        margin-left: 0.5rem;
    }

    .loader-bar {
        width: 200px;
        height: 3px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        overflow: hidden;
        margin: 0 auto;
    }

    :global([data-theme="light"]) .loader-bar {
        background: rgba(0, 0, 0, 0.1);
    }

    .loader-progress {
        height: 100%;
        width: 0%;
        background: linear-gradient(
            90deg,
            var(--sl-color-accent, #f39c12),
            #fff
        );
        border-radius: 3px;
        animation: loading 1.5s ease-in-out infinite;
    }

    @media (prefers-reduced-motion: reduce) {
        .loader-progress {
            animation: none;
            width: 100%;
        }
    }

    @keyframes loading {
        0% {
            width: 0%;
            margin-left: 0%;
        }
        50% {
            width: 70%;
            margin-left: 15%;
        }
        100% {
            width: 0%;
            margin-left: 100%;
        }
    }
</style>
