---
// 页面加载动画组件
---

<div class="page-loader" id="pageLoader">
    <div class="loader-content">
        <div class="loader-logo">
            <span class="logo-text">HUAT</span>
            <span class="logo-accent">FSAC</span>
        </div>
        <div class="loader-bar">
            <div class="loader-progress"></div>
        </div>
    </div>
</div>

<script is:inline>
    // 使用立即执行函数 (IIFE) 避免污染全局作用域
    // 使用 is:inline 确保脚本在 HTML 解析时立即执行，防止页面闪烁
    (function () {
        const loader = document.getElementById("pageLoader");
        if (!loader) return;

        // 防止重复初始化
        try {
            if (loader.dataset && loader.dataset.huatInit === "1") return;
            loader.dataset.huatInit = "1";
        } catch (e) {}

        const STORAGE_KEY = "huat_fsac_visited";
        const hasVisited = sessionStorage.getItem(STORAGE_KEY);

        const MIN_VISIBLE_MS = 350;
        const MAX_WAIT_MS = 1500;
        const startTime = Date.now();
        let revealTimeoutId = null;
        let maxWaitId = null;

        function dispatchHidden() {
            requestAnimationFrame(function () {
                window.dispatchEvent(new CustomEvent("pageLoaderHidden"));
            });
        }

        function revealContent() {
            try {
                if (loader.classList.contains("loaded")) return;
                loader.classList.add("loaded");

                // 等待 CSS transition 完成后彻底隐藏
                revealTimeoutId = window.setTimeout(function () {
                    try {
                        loader.style.display = "none";
                    } catch (e) {}
                    dispatchHidden();
                }, 250);
            } catch (e) {}
        }

        function hideLoader() {
            try {
                if (loader.classList.contains("loaded")) return;
                const elapsed = Date.now() - startTime;
                const delay = Math.max(0, MIN_VISIBLE_MS - elapsed);
                revealTimeoutId = window.setTimeout(revealContent, delay);
            } catch (e) {}
        }

        if (hasVisited) {
            // 立即隐藏，防止闪烁
            try {
                loader.style.display = "none";
            } catch (e) {}
            try {
                loader.classList.add("loaded");
            } catch (e) {}
            dispatchHidden();
        } else {
            // 标记本次会话已访问
            try {
                sessionStorage.setItem(STORAGE_KEY, "true");
            } catch (e) {}

            // 首次访问时，等待 DOM 就绪即可隐藏，避免阻塞图片加载
            if (
                document.readyState === "complete" ||
                document.readyState === "interactive"
            ) {
                hideLoader();
            } else {
                document.addEventListener("DOMContentLoaded", hideLoader, {
                    once: true,
                });
            }

            // 保底策略：如果长时间没有完成，强制进入
            maxWaitId = window.setTimeout(hideLoader, MAX_WAIT_MS);
        }

        function cleanup() {
            try {
                if (revealTimeoutId) clearTimeout(revealTimeoutId);
            } catch (e) {}
            try {
                if (maxWaitId) clearTimeout(maxWaitId);
            } catch (e) {}
            try {
                delete loader.dataset.huatInit;
            } catch (e) {}
            try {
                delete loader.__huatCleanup;
            } catch (e) {}
        }

        try {
            loader.__huatCleanup = cleanup;
        } catch (e) {}
        try {
            window.addEventListener("beforeunload", cleanup);
        } catch (e) {}
    })();
</script>

<style>
    .page-loader {
        position: fixed;
        inset: 0;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        transition:
            opacity 0.2s ease,
            visibility 0.2s ease;
    }

    :global([data-theme="light"]) .page-loader {
        background: #fff;
    }

    .page-loader.loaded {
        opacity: 0;
        visibility: hidden;
    }

    .loader-content {
        text-align: center;
    }

    .loader-logo {
        font-size: 3rem;
        font-weight: 900;
        letter-spacing: -2px;
        margin-bottom: 2rem;
    }

    .logo-text {
        color: #fff;
    }

    :global([data-theme="light"]) .logo-text {
        color: #000;
    }

    .logo-accent {
        color: var(--sl-color-accent, #f39c12);
        margin-left: 0.5rem;
    }

    .loader-bar {
        width: 200px;
        height: 3px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        overflow: hidden;
        margin: 0 auto;
    }

    :global([data-theme="light"]) .loader-bar {
        background: rgba(0, 0, 0, 0.1);
    }

    .loader-progress {
        height: 100%;
        width: 0%;
        background: linear-gradient(
            90deg,
            var(--sl-color-accent, #f39c12),
            #fff
        );
        border-radius: 3px;
        animation: loading 1.5s ease-in-out infinite;
    }

    @media (prefers-reduced-motion: reduce) {
        .loader-progress {
            animation: none;
            width: 100%;
        }
    }

    @keyframes loading {
        0% {
            width: 0%;
            margin-left: 0%;
        }
        50% {
            width: 70%;
            margin-left: 15%;
        }
        100% {
            width: 0%;
            margin-left: 100%;
        }
    }
</style>
