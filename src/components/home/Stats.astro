---
import type { StatItem } from "../../data/home";

interface Props {
    stats: StatItem[];
}

const { stats } = Astro.props;

// 解析数值和后缀（如 "50+" -> { num: 50, suffix: "+" }）
function parseValue(value: string) {
    const match = value.match(/^(\d+)(.*)$/);
    if (match) {
        return { num: parseInt(match[1]), suffix: match[2] || "" };
    }
    return { num: 0, suffix: value };
}
---

<div class="stats-bar">
    {
        stats.map((stat) => {
            const { num, suffix } = parseValue(stat.value);
            return (
                <div class="stat-item">
                    <div class="value" data-target={num} data-suffix={suffix}>
                        0{suffix}
                    </div>
                    <div class="label">{stat.label}</div>
                </div>
            );
        })
    }
</div>

<script>
    // 等待 PageLoader 消失后再启动动画（包含 init guard 与 cleanup）
    function initCounters() {
        if (typeof document === "undefined") return;
        const container = document.querySelector(
            ".stats-bar",
        ) as HTMLElement | null;
        if (!container) return;

        // 防止重复初始化
        if ((container as any).dataset?.huatInit === "1") return;
        (container as any).dataset.huatInit = "1";

        let counterObserver: IntersectionObserver | null = null;
        let fallbackId: number | null = null;

        function animateCounters() {
            const counters = document.querySelectorAll(
                ".stat-item .value[data-target]",
            );

            counterObserver = new IntersectionObserver(
                (entries) => {
                    entries.forEach((entry) => {
                        if (entry.isIntersecting) {
                            const el = entry.target as HTMLElement;

                            // 防止重复动画
                            if (el.dataset.animated) return;
                            el.dataset.animated = "true";

                            const target = parseInt(el.dataset.target || "0");
                            const suffix = el.dataset.suffix || "";
                            const duration = 2000; // 动画时长 2 秒
                            const startTime = performance.now();

                            function updateCounter(currentTime: number) {
                                const elapsed = currentTime - startTime;
                                const progress = Math.min(
                                    elapsed / duration,
                                    1,
                                );
                                const easeProgress =
                                    1 - Math.pow(1 - progress, 4);
                                const current = Math.floor(
                                    easeProgress * target,
                                );

                                el.textContent = current + suffix;

                                if (progress < 1) {
                                    requestAnimationFrame(updateCounter);
                                } else {
                                    el.textContent = target + suffix;
                                }
                            }

                            requestAnimationFrame(updateCounter);
                            counterObserver?.unobserve(el);
                        }
                    });
                },
                { threshold: 0.1 },
            );

            counters.forEach((counter) => counterObserver?.observe(counter));
        }

        const loader = document.getElementById("pageLoader");
        if (loader && !loader.classList.contains("loaded")) {
            window.addEventListener("pageLoaderHidden", animateCounters, {
                once: true,
            });
            fallbackId = window.setTimeout(animateCounters, 3000);
        } else {
            animateCounters();
        }

        function cleanup() {
            try {
                if (counterObserver) counterObserver.disconnect();
            } catch (e) {}
            try {
                if (fallbackId) clearTimeout(fallbackId);
            } catch (e) {}
            try {
                delete (container as any).dataset.huatInit;
            } catch (e) {}
            try {
                delete (container as any).__huatCleanup;
            } catch (e) {}
        }

        (container as any).__huatCleanup = cleanup;
        window.addEventListener("beforeunload", cleanup);
    }

    // 页面加载完成后初始化
    document.addEventListener("DOMContentLoaded", initCounters);
    // 兼容 View Transitions
    document.addEventListener("astro:page-load", initCounters);
</script>

<style>
    .stats-bar {
        position: relative;
        z-index: 2;
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 2rem;
        padding: 4rem 2rem;
        max-width: 1400px;
        margin: 0 auto 4rem;
        border-bottom: 1px solid
            var(--sl-color-gray-5, rgba(255, 255, 255, 0.1));
        text-align: center;
    }

    .stat-item {
        flex: 1;
        min-width: 250px;
        max-width: 350px;
        padding: 2.5rem 2rem;
        border-radius: 1.5rem;
        background: var(--sl-color-gray-6, rgba(255, 255, 255, 0.03));
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid var(--sl-color-gray-5, rgba(255, 255, 255, 0.05));
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    :global([data-theme="light"]) .stat-item {
        background: rgba(255, 255, 255, 0.5);
        border-color: rgba(0, 0, 0, 0.1);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .stat-item:hover {
        transform: translateY(-5px);
        background: var(--sl-color-gray-5, rgba(255, 255, 255, 0.06));
        border-color: var(--sl-color-gray-4, rgba(255, 255, 255, 0.15));
    }

    :global([data-theme="light"]) .stat-item:hover {
        background: rgba(255, 255, 255, 0.8);
        border-color: rgba(0, 0, 0, 0.2);
    }

    .stat-item .value {
        font-size: 3.5rem;
        font-weight: 800;
        line-height: 1;
        background: linear-gradient(
            135deg,
            var(--sl-color-accent) 0%,
            var(--sl-color-text) 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.5rem;
    }

    .stat-item .label {
        font-size: 1rem;
        font-weight: 500;
        letter-spacing: 2px;
        text-transform: uppercase;
        opacity: 0.7;
    }
</style>
