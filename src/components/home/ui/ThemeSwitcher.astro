---
// ‰∏ªÈ¢òËâ≤ÂàáÊç¢ÁªÑ‰ª∂ - ÂèØÂú®‰∏çÂêåËµõÂ≠£‰∏ªÈ¢òËâ≤Èó¥ÂàáÊç¢
interface ThemeOption {
    name: string;
    color: string;
    accent: string;
}

const themes: ThemeOption[] = [
    { name: "ÁªèÂÖ∏Ê©ô", color: "#f39c12", accent: "#e67e22" },
    { name: "ÁîµÁ´ûËìù", color: "#3498db", accent: "#2980b9" },
    { name: "ËµõÈÅìÁ∫¢", color: "#e74c3c", accent: "#c0392b" },
    { name: "ÁßëÊäÄÁ¥´", color: "#9b59b6", accent: "#8e44ad" },
    { name: "ÊûÅÈÄüÁªø", color: "#2ecc71", accent: "#27ae60" },
];
---

<div class="theme-switcher">
    <button class="theme-toggle" aria-label="ÂàáÊç¢‰∏ªÈ¢òËâ≤" title="ÂàáÊç¢‰∏ªÈ¢òËâ≤">
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
        >
            <circle cx="12" cy="12" r="5"></circle>
            <path
                d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"
            ></path>
        </svg>
    </button>
    <div class="theme-dropdown">
        <div class="theme-dropdown-header">üé® ‰∏ªÈ¢òËâ≤</div>
        <div class="mode-controls" aria-hidden="false">
            <button
                class="mode-btn"
                data-mode="light"
                aria-label="ÂàáÊç¢Âà∞‰∫ÆËâ≤Ê®°Âºè">‰∫Æ</button
            >
            <button
                class="mode-btn"
                data-mode="dark"
                aria-label="ÂàáÊç¢Âà∞ÊöóËâ≤Ê®°Âºè">Êöó</button
            >
        </div>
        {
            themes.map((theme, index) => (
                <button
                    class="theme-option"
                    data-color={theme.color}
                    data-accent={theme.accent}
                    data-index={index}
                    style={`--preview-color: ${theme.color}`}
                >
                    <span class="color-preview" />
                    <span class="theme-name">{theme.name}</span>
                </button>
            ))
        }
    </div>
</div>

<script>
    function initThemeSwitcher() {
        const toggle = document.querySelector(".theme-toggle");
        const dropdown = document.querySelector(".theme-dropdown");
        const options = document.querySelectorAll(".theme-option");
        const modeButtons = document.querySelectorAll(".mode-btn");

        // ËØªÂèñÂπ∂Â∫îÁî®Â∑≤‰øùÂ≠òÁöÑ‰∫Æ/ÊöóÊ®°ÂºèÔºà‰ºòÂÖàÔºâ
        const savedScheme = localStorage.getItem("huat-color-scheme");
        if (savedScheme) {
            document.documentElement.setAttribute("data-theme", savedScheme);
            updateModeButtons(savedScheme);
        } else if (
            window.matchMedia &&
            window.matchMedia("(prefers-color-scheme: dark)").matches
        ) {
            document.documentElement.setAttribute("data-theme", "dark");
            updateModeButtons("dark");
        }

        // ‰ªé localStorage ËØªÂèñ‰øùÂ≠òÁöÑ‰∏ªÈ¢ò
        const savedTheme = localStorage.getItem("huat-theme-color");
        const savedAccent = localStorage.getItem("huat-theme-accent");
        if (savedTheme && savedAccent) {
            applyTheme(savedTheme, savedAccent);
        }

        // ÂàáÊç¢‰∏ãÊãâËèúÂçï
        toggle?.addEventListener("click", (e) => {
            e.stopPropagation();
            dropdown?.classList.toggle("active");
        });

        // ÁÇπÂáªÈÄâÈ°πÂ∫îÁî®‰∏ªÈ¢ò
        options.forEach((option) => {
            option.addEventListener("click", () => {
                const color = (option as HTMLElement).dataset.color;
                const accent = (option as HTMLElement).dataset.accent;
                if (color && accent) {
                    applyTheme(color, accent);
                    localStorage.setItem("huat-theme-color", color);
                    localStorage.setItem("huat-theme-accent", accent);
                }
                dropdown?.classList.remove("active");
            });
        });

        // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠‰∏ãÊãâËèúÂçï
        document.addEventListener("click", () => {
            dropdown?.classList.remove("active");
        });

        // ‰∫Æ/ÊöóÊ®°ÂºèÊåâÈíÆÂ§ÑÁêÜ
        modeButtons.forEach((btn) => {
            btn.addEventListener("click", (e) => {
                e.stopPropagation();
                const mode = (btn as HTMLElement).dataset.mode;
                if (mode === "light" || mode === "dark") {
                    document.documentElement.setAttribute("data-theme", mode);
                    localStorage.setItem("huat-color-scheme", mode);
                    updateModeButtons(mode);
                }
            });
        });
    }

    function applyTheme(color: string, accent: string) {
        document.documentElement.style.setProperty("--sl-color-accent", color);
        document.documentElement.style.setProperty(
            "--sl-color-accent-high",
            accent,
        );

        // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
        document.querySelectorAll(".theme-option").forEach((opt) => {
            opt.classList.remove("active");
            if ((opt as HTMLElement).dataset.color === color) {
                opt.classList.add("active");
            }
        });
    }

    document.addEventListener("DOMContentLoaded", initThemeSwitcher);
    document.addEventListener("astro:page-load", initThemeSwitcher);

    function updateModeButtons(mode: string) {
        document.querySelectorAll(".mode-btn").forEach((b) => {
            b.classList.remove("active");
            if ((b as HTMLElement).dataset.mode === mode)
                b.classList.add("active");
        });
    }
</script>

<style>
    .theme-switcher {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 1000;
    }

    .theme-toggle {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--sl-color-gray-6, rgba(255, 255, 255, 0.1));
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--sl-color-gray-5, rgba(255, 255, 255, 0.15));
        color: var(--sl-color-text, white);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    :global([data-theme="light"]) .theme-toggle {
        background: rgba(255, 255, 255, 0.8);
        color: #000;
        border-color: rgba(0, 0, 0, 0.1);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .theme-toggle:hover {
        background: var(--sl-color-gray-5, rgba(255, 255, 255, 0.2));
        transform: scale(1.1);
        border-color: var(--sl-color-accent);
    }

    :global([data-theme="light"]) .theme-toggle:hover {
        background: #fff;
    }

    .theme-dropdown {
        position: absolute;
        bottom: 60px;
        right: 0;
        background: var(--sl-color-bg-nav, rgba(20, 20, 20, 0.95));
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--sl-color-gray-5, rgba(255, 255, 255, 0.1));
        border-radius: 1rem;
        padding: 0.5rem;
        min-width: 160px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(10px);
        transition: all 0.3s ease;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    :global([data-theme="light"]) .theme-dropdown {
        background: rgba(255, 255, 255, 0.95);
        border-color: rgba(0, 0, 0, 0.1);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }

    .theme-dropdown.active {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .theme-dropdown-header {
        padding: 0.75rem 1rem 0.5rem;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--sl-color-gray-3, rgba(255, 255, 255, 0.5));
        border-bottom: 1px solid
            var(--sl-color-gray-5, rgba(255, 255, 255, 0.1));
        margin-bottom: 0.5rem;
    }

    .mode-controls {
        display: flex;
        gap: 0.5rem;
        padding: 0.5rem 1rem 0.75rem;
        justify-content: flex-end;
        align-items: stretch;
    }

    .mode-btn {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: var(--sl-color-text);
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        cursor: pointer;
        font-size: 0.85rem;
        min-width: 64px;
        width: 64px;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        line-height: 1;
        box-sizing: border-box;
        vertical-align: middle;
    }

    :global([data-theme="light"]) .mode-btn {
        border-color: rgba(0, 0, 0, 0.06);
        color: #111;
    }

    .mode-btn.active {
        background: var(--sl-color-accent);
        color: #fff;
        border-color: var(--sl-color-accent);
    }

    .theme-option {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
        padding: 0.75rem 1rem;
        background: transparent;
        border: none;
        border-radius: 0.5rem;
        color: var(--sl-color-text, white);
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: left;
    }

    .theme-option:hover {
        background: var(--sl-color-gray-5, rgba(255, 255, 255, 0.1));
    }

    :global([data-theme="light"]) .theme-option:hover {
        background: rgba(0, 0, 0, 0.05);
    }

    .theme-option.active {
        background: var(--sl-color-gray-5, rgba(255, 255, 255, 0.15));
    }

    :global([data-theme="light"]) .theme-option.active {
        background: rgba(0, 0, 0, 0.1);
    }

    .color-preview {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--preview-color);
        box-shadow: 0 2px 8px var(--preview-color);
        transition: transform 0.2s ease;
    }

    .theme-option:hover .color-preview {
        transform: scale(1.2);
    }

    .theme-name {
        font-size: 0.9rem;
        font-weight: 500;
    }

    @media (max-width: 768px) {
        .theme-switcher {
            bottom: 1rem;
            right: 1rem;
        }

        .theme-toggle {
            width: 44px;
            height: 44px;
        }
    }
</style>
